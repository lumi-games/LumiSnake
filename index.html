<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMISNAKE alpha 0.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            margin: 0; 
            background: #010501; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow: hidden; 
            font-family: 'Orbitron', sans-serif; 
            color: #0f0; 
        }
        canvas#bg { position: fixed; z-index: -1; top: 0; left: 0; }
        
        .box { 
            background: rgba(0, 15, 0, 0.95); 
            border: 3px solid #0f0; 
            border-radius: 50px; 
            box-shadow: 0 0 80px rgba(0, 255, 0, 0.4); 
            backdrop-filter: blur(20px); 
            text-align: center; 
        }
        
        #main-menu { 
            padding: 60px 100px;
            min-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #main-menu h1 {
            font-size: 72px;
            margin-bottom: 10px;
            text-shadow: 0 0 30px #0f0, 0 0 60px #0f0;
            letter-spacing: 8px;
        }
        #main-menu .subtitle {
            font-size: 18px;
            opacity: 0.6;
            letter-spacing: 4px;
            margin-bottom: 50px;
        }
        
        .menu-buttons { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            width: 100%;
            max-width: 400px;
        }
        .menu-buttons .btn {
            font-size: 24px;
            padding: 20px 60px;
        }
        
        .popup-box { 
            display: none; 
            padding: 40px; 
            position: relative; 
            width: 500px; 
        }
        #skins-menu { width: 650px; max-height: 85vh; overflow-y: auto; }
        #leaderboard-menu { width: 550px; max-height: 85vh; }
        #auth-modal { width: 500px; max-height: 85vh; overflow-y: auto; }
        #messages-modal { width: 550px; max-height: 85vh; }
        #battle-config { width: 450px; }
        #battle-search { width: 500px; }
        
        .close-btn { 
            position: absolute; 
            top: 25px; 
            right: 25px; 
            width: 50px; 
            height: 50px; 
            background: #f00; 
            border: none; 
            border-radius: 15px; 
            color: white; 
            cursor: pointer; 
            box-shadow: 0 0 20px #f00; 
            font-weight: bold; 
            font-family: 'Orbitron'; 
            font-size: 20px;
            transition: 0.3s;
            z-index: 10;
        }
        .close-btn:hover { background: #ff3333; transform: scale(1.1); }
        
        #coin-display { 
            position: fixed; 
            top: 30px; 
            right: 30px; 
            background: rgba(0, 20, 0, 0.95); 
            border: 3px solid gold; 
            border-radius: 30px; 
            padding: 15px 35px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5); 
            z-index: 100; 
        }
        #coin-display.hidden { display: none; }
        .coin-icon { 
            width: 36px; 
            height: 36px; 
            background: linear-gradient(135deg, #ffd700, #ffaa00); 
            border-radius: 50%; 
            border: 3px solid #cc8800; 
            box-shadow: 0 0 15px gold; 
        }
        #coin-count { 
            color: gold; 
            font-size: 28px; 
            font-weight: bold; 
            text-shadow: 0 0 15px gold; 
        }

        #user-display {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(0, 20, 0, 0.95);
            border: 3px solid #0f0;
            border-radius: 30px;
            padding: 12px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.4);
            z-index: 100;
            cursor: pointer;
            transition: 0.3s;
        }
        #user-display:hover { box-shadow: 0 0 40px rgba(0, 255, 0, 0.6); }
        #user-display.hidden { display: none; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #0f0;
            background: #001500;
            object-fit: cover;
        }
        .user-avatar.default {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        #user-name {
            font-size: 16px;
            color: #0f0;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .msg-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #f00;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px #f00;
        }
        .msg-badge.hidden { display: none; }

        #leaderboard-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 20, 0, 0.95);
            border: 3px solid #ffaa00;
            border-radius: 20px;
            padding: 15px 30px;
            color: #ffaa00;
            font-family: 'Orbitron';
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 170, 0, 0.4);
            transition: 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #leaderboard-btn:hover {
            box-shadow: 0 0 40px rgba(255, 170, 0, 0.7);
            transform: scale(1.05);
        }
        #leaderboard-btn.hidden { display: none; }

        #music-toggle {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(0, 20, 0, 0.95);
            border: 3px solid #0f0;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: #0f0;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.4);
            transition: 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #music-toggle:hover { box-shadow: 0 0 40px rgba(0, 255, 0, 0.7); transform: scale(1.1); }
        #music-toggle.muted { border-color: #f00; color: #f00; box-shadow: 0 0 25px rgba(255, 0, 0, 0.4); }
        #music-toggle.hidden { display: none; }

        #game-ui { 
            display: none; 
            margin-bottom: 20px; 
            background: rgba(0, 20, 0, 0.9); 
            padding: 15px 50px; 
            border: 3px solid #0f0; 
            border-radius: 25px; 
            box-shadow: 0 0 30px #0f05; 
            font-size: 28px; 
            position: relative; 
        }
        #score-pop { position: absolute; right: -70px; top: 0; font-weight: 900; opacity: 0; pointer-events: none; font-size: 32px; }
        .pop-active { animation: float-up 0.8s ease-out; }
        #coin-pop { position: absolute; right: -140px; top: 0; font-weight: 900; opacity: 0; pointer-events: none; font-size: 24px; color: gold; }
        .coin-pop-active { animation: float-up 0.8s ease-out; }

        #battle-timer {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 36px;
            color: #ff0;
            text-shadow: 0 0 20px #ff0;
        }
        #battle-timer.warning { color: #f00; text-shadow: 0 0 20px #f00; animation: pulse 0.5s infinite; }
        
        #opponent-score {
            position: absolute;
            left: -200px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #f55;
            border-radius: 15px;
            padding: 10px 20px;
            font-size: 18px;
            color: #f55;
        }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1.2); }
            100% { opacity: 0; transform: translateY(-50px) scale(1); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #new-record-overlay, #battle-result-overlay, #battle-prep-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #new-record-overlay.active, #battle-result-overlay.active, #battle-prep-overlay.active { display: flex; }
        
        .overlay-title {
            font-size: 60px;
            text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
            animation: pulse-record 0.5s ease-in-out infinite alternate;
        }
        .overlay-title.gold { color: gold; }
        .overlay-title.green { color: #0f0; }
        .overlay-title.red { color: #f00; }
        
        .overlay-score {
            font-size: 100px;
            color: #0f0;
            text-shadow: 0 0 40px #0f0;
            margin: 20px 0;
        }
        .overlay-subtitle {
            font-size: 24px;
            color: #fff;
            opacity: 0.8;
            margin: 10px 0;
            max-width: 600px;
            text-align: center;
            line-height: 1.5;
        }
        .overlay-reward {
            font-size: 28px;
            color: gold;
            margin: 20px 0;
        }
        
        #prep-timer {
            font-size: 120px;
            color: #ff0;
            text-shadow: 0 0 50px #ff0;
            margin: 30px 0;
        }
        
        @keyframes pulse-record {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        #game-container { 
            display: none; 
            border-radius: 30px; 
            border: 5px solid #0f0; 
            box-shadow: 0 0 60px #0f0; 
            overflow: hidden; 
            position: relative; 
        }
        #game-container.battle-mode { border-color: #ff0; box-shadow: 0 0 60px #ff0; }
        canvas#game { background: #000; display: block; }

        .option { margin: 20px 0; text-align: left; font-size: 16px; }
        .option label { font-size: 16px; }
        select, input[type="number"], input[type="text"] { 
            width: 100%; 
            background: #001500; 
            border: 2px solid #0f0; 
            border-radius: 12px; 
            color: #0f0; 
            padding: 12px; 
            font-family: 'Orbitron'; 
            font-size: 16px;
            margin-top: 8px; 
        }

        .custom-check { display: flex; align-items: center; gap: 15px; cursor: pointer; margin-top: 12px; font-size: 16px; }
        .custom-check input { display: none; }
        .check-circle { 
            width: 28px; 
            height: 28px; 
            border: 3px solid #0f0; 
            border-radius: 50%; 
            position: relative; 
            transition: 0.3s; 
            box-shadow: 0 0 12px #0f03; 
        }
        .custom-check input:checked + .check-circle { background: #0f0; box-shadow: 0 0 20px #0f0; }
        .custom-check input:checked + .check-circle::after { 
            content: ''; 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 12px; 
            height: 12px; 
            background: #000; 
            border-radius: 50%; 
        }

        .slider-container { margin: 25px 0; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 16px; }
        .slider-track { 
            width: 100%; 
            height: 16px; 
            background: #001500; 
            border: 2px solid #0f0; 
            border-radius: 12px; 
            position: relative; 
            cursor: pointer; 
            box-shadow: inset 0 0 15px #000; 
        }
        .slider-fill { height: 100%; background: linear-gradient(90deg, #004400, #00ff00); border-radius: 10px; transition: width 0.1s; }
        .slider-handle { 
            width: 32px; 
            height: 32px; 
            background: radial-gradient(circle at 30% 30%, #33ff33, #00aa00); 
            border: 4px solid #0f0; 
            border-radius: 50%; 
            position: absolute; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            cursor: grab; 
            box-shadow: 0 0 20px #0f0; 
        }

        .skins-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 25px; }
        .skin-card { 
            background: rgba(0, 30, 0, 0.8); 
            border: 3px solid #0f0; 
            border-radius: 25px; 
            padding: 20px; 
            text-align: center; 
            transition: 0.3s; 
            cursor: pointer;
        }
        .skin-card:hover { box-shadow: 0 0 25px #0f0; transform: translateY(-5px); }
        .skin-card.owned { border-color: gold; }
        .skin-card.selected { border-color: #00ffff; box-shadow: 0 0 30px #00ffff; }
        .skin-card.locked { opacity: 0.6; }
        .skin-preview { height: 60px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .skin-line { width: 85%; height: 14px; border-radius: 7px; box-shadow: 0 0 20px currentColor; }
        .skin-name { font-size: 12px; margin-bottom: 8px; opacity: 0.8; }
        .skin-price { font-size: 16px; color: gold; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .skin-price .mini-coin { width: 20px; height: 20px; background: linear-gradient(135deg, #ffd700, #ffaa00); border-radius: 50%; border: 2px solid #cc8800; }
        .skin-btn { 
            background: transparent; 
            border: 2px solid #0f0; 
            color: #0f0; 
            padding: 10px 25px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-family: 'Orbitron'; 
            font-size: 12px; 
            transition: 0.2s; 
            width: 100%; 
        }
        .skin-btn:hover { background: #0f0; color: #000; }
        .skin-btn.owned-btn { border-color: gold; color: gold; }
        .skin-btn.selected-btn { background: #00ffff; border-color: #00ffff; color: #000; }
        .skin-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .leaderboard-list { margin-top: 25px; max-height: 400px; overflow-y: auto; }
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: rgba(0, 30, 0, 0.6);
            border: 2px solid #0f03;
            border-radius: 15px;
            margin-bottom: 10px;
            transition: 0.3s;
        }
        .leaderboard-item:hover { border-color: #0f0; cursor: pointer; transform: translateX(5px); }
        .leaderboard-item.gold { border-color: gold; background: rgba(255, 215, 0, 0.1); }
        .leaderboard-item.silver { border-color: silver; background: rgba(192, 192, 192, 0.1); }
        .leaderboard-item.bronze { border-color: #cd7f32; background: rgba(205, 127, 50, 0.1); }
        .lb-rank { font-size: 24px; font-weight: bold; width: 50px; text-align: center; }
        .lb-rank.gold { color: gold; }
        .lb-rank.silver { color: silver; }
        .lb-rank.bronze { color: #cd7f32; }
        .lb-avatar { width: 45px; height: 45px; border-radius: 50%; border: 2px solid #0f0; object-fit: cover; background: #001500; }
        .lb-info { flex: 1; text-align: left; }
        .lb-name { font-size: 16px; color: #0f0; }
        .lb-trophies { font-size: 12px; color: #ffaa00; margin-top: 3px; }
        .lb-score { font-size: 20px; color: gold; font-weight: bold; }

        .profile-section { margin-top: 20px; }
        .profile-field { margin: 15px 0; text-align: left; }
        .profile-field label { font-size: 14px; opacity: 0.8; display: block; margin-bottom: 8px; }
        .profile-field input[type="text"], .profile-field textarea {
            width: 100%;
            background: #001500;
            border: 2px solid #0f0;
            border-radius: 12px;
            color: #0f0;
            padding: 12px;
            font-family: 'Orbitron';
            font-size: 14px;
            resize: none;
        }
        .profile-field textarea { height: 80px; }
        .profile-stats { 
            display: flex; 
            justify-content: space-around; 
            margin: 20px 0; 
            padding: 15px; 
            background: rgba(0, 50, 0, 0.5); 
            border-radius: 15px; 
        }
        .profile-stat { text-align: center; }
        .profile-stat-value { font-size: 24px; color: gold; font-weight: bold; }
        .profile-stat-label { font-size: 11px; opacity: 0.7; margin-top: 5px; }

        #profile-view { width: 500px; }
        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .profile-avatar-large { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #0f0; object-fit: cover; background: #001500; }
        .profile-name-large { font-size: 24px; color: #0f0; }
        .profile-email { font-size: 12px; opacity: 0.6; margin-top: 5px; }
        .profile-description { 
            background: rgba(0, 30, 0, 0.6); 
            border: 2px solid #0f03; 
            border-radius: 15px; 
            padding: 15px; 
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.5;
            min-height: 60px;
        }
        .profile-info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #0f03;
            font-size: 14px;
        }
        .profile-info-label { opacity: 0.7; }
        .profile-info-value { color: #0f0; font-weight: bold; }
        .profile-info-value.gold { color: gold; }
        .profile-info-value.orange { color: #ffaa00; }

        .messages-list { max-height: 350px; overflow-y: auto; margin: 20px 0; }
        .message-item {
            background: rgba(0, 30, 0, 0.6);
            border: 2px solid #0f03;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            text-align: left;
        }
        .message-item.unread { border-color: #0f0; background: rgba(0, 50, 0, 0.6); }
        .message-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 12px; }
        .message-from { color: #0f0; font-weight: bold; }
        .message-date { opacity: 0.6; }
        .message-text { font-size: 14px; line-height: 1.4; }
        .message-actions { margin-top: 10px; display: flex; gap: 10px; }
        .message-actions button { 
            background: transparent; 
            border: 1px solid #0f0; 
            color: #0f0; 
            padding: 5px 15px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-family: 'Orbitron'; 
            font-size: 11px; 
        }
        .message-actions button:hover { background: #0f0; color: #000; }
        .message-actions button.delete { border-color: #f00; color: #f00; }
        .message-actions button.delete:hover { background: #f00; color: #fff; }

        .compose-message { margin-top: 20px; }
        .compose-message textarea {
            width: 100%;
            height: 100px;
            background: #001500;
            border: 2px solid #0f0;
            border-radius: 12px;
            color: #0f0;
            padding: 12px;
            font-family: 'Orbitron';
            font-size: 14px;
            resize: none;
            margin-bottom: 10px;
        }

        button.btn { 
            margin-top: 20px; 
            background: transparent; 
            border: 3px solid #0f0; 
            color: #0f0; 
            padding: 15px 50px; 
            border-radius: 50px; 
            cursor: pointer; 
            font-family: 'Orbitron'; 
            font-size: 18px;
            transition: 0.3s; 
            width: 100%; 
        }
        button.btn:hover { background: #0f0; color: #000; box-shadow: 0 0 40px #0f0; }
        button.btn:disabled { opacity: 0.5; cursor: not-allowed; }
        button.btn.battle { border-color: #ff0; color: #ff0; }
        button.btn.battle:hover { background: #ff0; color: #000; box-shadow: 0 0 40px #ff0; }
        button.btn.danger { border-color: #f00; color: #f00; }
        button.btn.danger:hover { background: #f00; color: #fff; }
        button.btn.small { padding: 10px 25px; font-size: 14px; margin-top: 10px; }

        h2 { font-size: 32px; margin-bottom: 20px; }

        #toast-container {
            position: fixed;
            top: 100px;
            right: 30px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: rgba(0, 30, 0, 0.95);
            border: 2px solid #0f0;
            border-radius: 15px;
            padding: 15px 25px;
            color: #0f0;
            font-family: 'Orbitron';
            font-size: 14px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-out 2.7s forwards;
        }
        .toast.gold { border-color: gold; color: gold; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .searching-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
        }
        .searching-dot {
            width: 20px;
            height: 20px;
            background: #0f0;
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }
        .searching-dot:nth-child(2) { animation-delay: 0.2s; }
        .searching-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #001500; border-radius: 5px; }
        ::-webkit-scrollbar-thumb { background: #0f0; border-radius: 5px; }

        .dev-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .dev-tab {
            flex: 1;
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid #0f0;
            background: transparent;
            color: #0f0;
            cursor: pointer;
            font-family: 'Orbitron';
            font-size: 12px;
            transition: 0.2s;
        }
        .dev-tab.active {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 20px #0f0;
        }
        .dev-content {
            margin-top: 10px;
            max-height: 55vh;
            overflow-y: auto;
            text-align: left;
            font-size: 12px;
        }
        .dev-stat-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .dev-stat-card {
            flex: 1;
            background: rgba(0, 30, 0, 0.7);
            border-radius: 15px;
            padding: 10px 15px;
            border: 2px solid #0f03;
        }
        .dev-stat-card .val {
            font-size: 20px;
            color: gold;
            margin-bottom: 5px;
        }
        .dev-stat-card .label {
            font-size: 10px;
            opacity: 0.7;
        }
        .dev-user-list {
            max-height: 50vh;
            overflow-y: auto;
        }
        .dev-user-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            background: rgba(0, 30, 0, 0.7);
            border: 2px solid #0f03;
        }
        .dev-user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .dev-user-name { color: #0f0; font-weight: bold; }
        .dev-user-email { opacity: 0.7; font-size: 11px; }
        .dev-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .dev-status-online { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .dev-status-offline { background: #555; }
        .dev-user-fields {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .dev-user-fields input {
            flex: 1;
            font-size: 11px;
            padding: 6px 8px;
        }
        .dev-user-actions {
            margin-top: 6px;
            display: flex;
            gap: 6px;
        }
        .dev-user-actions button {
            flex: 1;
            padding: 6px 8px;
            font-size: 10px;
        }
        .profile-status {
            font-size: 11px;
            margin-top: 4px;
        }
        .profile-status.online { color: #0f0; }
        .profile-status.offline { color: #888; }

        #banned-screen {
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:#000;
            z-index:10000;
            flex-direction:column;
            justify-content:center;
            align-items:center;
            color:#f00;
            font-family:'Orbitron';
            text-align:center;
        }
    </style>
</head>
<body>
    <canvas id="bg"></canvas>
    <div id="toast-container"></div>

    <div id="new-record-overlay">
        <div class="overlay-title gold">üèÜ NEW RECORD! üèÜ</div>
        <div class="overlay-score" id="record-score">0</div>
        <div class="overlay-subtitle" id="first-place-msg" style="display:none;">üëë YOU ARE #1! üëë</div>
        <button class="btn" onclick="closeRecordOverlay()" style="max-width: 300px; margin-top: 40px;">CONTINUE</button>
    </div>

    <div id="battle-prep-overlay">
        <div class="overlay-title gold">‚öîÔ∏è BATTLE MODE ‚öîÔ∏è</div>
        <div class="overlay-subtitle" id="prep-text">You're fighting against <span id="opponent-name">OPPONENT</span>!</div>
        <div class="overlay-subtitle">Goal: Eat more apples than your opponent in 60 seconds!</div>
        <div id="prep-timer">20</div>
        <div class="overlay-subtitle">Get ready... GOOD LUCK!</div>
    </div>

    <div id="battle-result-overlay">
        <div class="overlay-title" id="result-title">VICTORY!</div>
        <div class="overlay-subtitle" id="result-scores"></div>
        <div class="overlay-reward" id="result-reward"></div>
        <button class="btn" onclick="closeBattleResult()" style="max-width: 300px; margin-top: 40px;">CONTINUE</button>
    </div>

    <div id="user-display" class="hidden" onclick="showAuthModal()">
        <div class="user-avatar default" id="user-avatar">üë§</div>
        <span id="user-name">Guest</span>
        <span class="msg-badge hidden" id="msg-badge">0</span>
    </div>

    <div id="coin-display">
        <div class="coin-icon"></div>
        <span id="coin-count">0</span>
    </div>

    <button id="music-toggle" onclick="toggleMusic()">üéµ</button>
    <button id="leaderboard-btn" onclick="showLeaderboard()">üèÜ LEADERBOARD</button>

    <div id="main-menu" class="box">
        <h1>LUMISNAKE</h1>
        <p class="subtitle">by: LUMIGAMES‚Ñ¢</p>
        <div class="menu-buttons">
            <button class="btn" onclick="showSettings()">‚ñ∂ START</button>
            <button class="btn battle" onclick="showBattleConfig()">‚öî BATTLE</button>
            <button class="btn" onclick="showAudioSettings()">‚öô SETTINGS</button>
            <button class="btn" onclick="showSkins()">üé® SKINS</button>
        </div>
    </div>

    <div id="auth-modal" class="box popup-box">
        <button class="close-btn" onclick="hideAuthModal()">X</button>
        <h2>üîê ACCOUNT</h2>
        
        <div id="auth-logged-out">
            <button class="google-btn" onclick="signInWithGoogle()" style="display:flex;align-items:center;justify-content:center;gap:15px;width:100%;padding:18px 30px;background:#fff;border:none;border-radius:30px;font-family:'Orbitron';font-size:16px;color:#333;cursor:pointer;transition:0.3s;margin-bottom:20px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width:28px;height:28px;">
                Sign in with Google
            </button>
            <p style="font-size:12px;opacity:0.6;">Sign in to save progress and compete!</p>
        </div>
        
        <div id="auth-logged-in" style="display: none;">
            <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;justify-content:center;">
                <img id="auth-avatar" class="user-avatar" src="" style="width:60px;height:60px;">
                <div style="text-align:left;">
                    <div id="auth-email" style="opacity:0.7;font-size:12px;"></div>
                    <div id="auth-username" style="font-size:20px;color:#0f0;"></div>
                </div>
            </div>
            
            <div class="profile-stats">
                <div class="profile-stat">
                    <div class="profile-stat-value" id="my-high-score">0</div>
                    <div class="profile-stat-label">HIGH SCORE</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="my-trophies">0</div>
                    <div class="profile-stat-label">üèÜ TROPHIES</div>
                </div>
                <div class="profile-stat">
                    <div class="profile-stat-value" id="my-coins">0</div>
                    <div class="profile-stat-label">COINS</div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-field">
                    <label>‚úèÔ∏è NICKNAME:</label>
                    <input type="text" id="profile-nickname" maxlength="20" placeholder="Enter nickname...">
                </div>
                <div class="profile-field">
                    <label>üìù DESCRIPTION:</label>
                    <textarea id="profile-description" maxlength="150" placeholder="Tell us about yourself..."></textarea>
                </div>
                <label class="custom-check" style="margin:15px 0;">
                    <input type="checkbox" id="profile-hide-email">
                    <span class="check-circle"></span>
                    üîí Hide my email from others
                </label>
            </div>
            
            <button class="btn small" onclick="saveProfile()">üíæ SAVE PROFILE</button>
            <button class="btn small" onclick="showMessages()">üì¨ MESSAGES <span id="msg-count-btn"></span></button>
            <button class="btn small danger" onclick="signOutUser()">LOGOUT</button>
        </div>
    </div>

    <div id="messages-modal" class="box popup-box">
        <button class="close-btn" onclick="hideMessages()">X</button>
        <h2>üì¨ MESSAGES</h2>
        <div class="messages-list" id="messages-list">
            <p style="opacity:0.6;text-align:center;padding:40px;">No messages yet</p>
        </div>
    </div>

    <div id="profile-view" class="box popup-box">
        <button class="close-btn" onclick="hideProfileView()">X</button>
        <h2>üë§ PROFILE</h2>
        <div class="profile-header">
            <img id="view-avatar" class="profile-avatar-large" src="">
            <div>
                <div class="profile-name-large" id="view-nickname">Player</div>
                <div class="profile-email" id="view-email"></div>
            </div>
        </div>
        <div class="profile-description" id="view-description">No description provided.</div>
        <div class="profile-info-row">
            <span class="profile-info-label">üèÜ High Score</span>
            <span class="profile-info-value gold" id="view-score">0</span>
        </div>
        <div class="profile-info-row">
            <span class="profile-info-label">‚öîÔ∏è Battle Trophies</span>
            <span class="profile-info-value orange" id="view-trophies">0</span>
        </div>
        <div class="profile-info-row">
            <span class="profile-info-label">üìÖ Member Since</span>
            <span class="profile-info-value" id="view-created">Unknown</span>
        </div>
        
        <div class="compose-message" id="compose-section" style="display:none;">
            <h3 style="font-size:16px;margin-bottom:10px;">‚úâÔ∏è Send Message</h3>
            <textarea id="compose-text" placeholder="Write your message..."></textarea>
            <button class="btn small" onclick="sendMessage()">SEND</button>
        </div>
        
        <button class="btn" onclick="hideProfileView()" style="margin-top:25px;">‚Üê BACK</button>
    </div>

    <div id="audio-settings" class="box popup-box">
        <button class="close-btn" onclick="hideAudioSettings()">X</button>
        <h2>‚öô SETTINGS</h2>
        <div class="slider-container">
            <div class="slider-label"><span>üîä SOUND</span><span id="sound-val">70%</span></div>
            <div class="slider-track" id="sound-slider">
                <div class="slider-fill" style="width:70%;"></div>
                <div class="slider-handle" style="left:70%;"></div>
            </div>
        </div>
        <div class="slider-container">
            <div class="slider-label"><span>üéµ MUSIC</span><span id="music-val">50%</span></div>
            <div class="slider-track" id="music-slider">
                <div class="slider-fill" style="width:50%;"></div>
                <div class="slider-handle" style="left:50%;"></div>
            </div>
        </div>
    </div>

    <div id="skins-menu" class="box popup-box">
        <button class="close-btn" onclick="hideSkins()">X</button>
        <h2>üé® SKINS</h2>
        <div class="skins-grid" id="skins-grid"></div>
    </div>

    <div id="leaderboard-menu" class="box popup-box">
        <button class="close-btn" onclick="hideLeaderboard()">X</button>
        <h2>üèÜ LEADERBOARD</h2>
        <div class="leaderboard-list" id="leaderboard-list">
            <p style="opacity:0.6;text-align:center;padding:40px;">Loading...</p>
        </div>
    </div>

    <div id="settings-menu" class="box popup-box">
        <button class="close-btn" onclick="hideSettings()">X</button>
        <h2>‚ö° CONFIG</h2>
        <div class="option">
            <label>LEVEL SIZE:</label>
            <select id="grid-size">
                <option value="10">10 x 10</option>
                <option value="25" selected>25 x 25</option>
            </select>
        </div>
        <div class="option">
            <label>APPLES (1-10):</label>
            <input type="number" id="apple-count" min="1" max="10" value="1">
        </div>
        <div class="option">
            <label class="custom-check">
                <input type="checkbox" id="no-walls">
                <span class="check-circle"></span>
                NO WALLS (TP)
            </label>
            <label class="custom-check">
                <input type="checkbox" id="allow-bonuses">
                <span class="check-circle"></span>
                ALLOW BONUSES
            </label>
        </div>
        <button class="btn" onclick="runGame()">üöÄ LAUNCH</button>
    </div>

    <div id="battle-config" class="box popup-box">
        <button class="close-btn" onclick="hideBattleConfig()">X</button>
        <h2>‚öî BATTLE CONFIG</h2>
        <div class="option">
            <label>ARENA SIZE:</label>
            <select id="battle-grid-size">
                <option value="15">15 x 15 (Small)</option>
                <option value="20" selected>20 x 20 (Medium)</option>
                <option value="25">25 x 25 (Large)</option>
            </select>
        </div>
        <p style="font-size:12px;opacity:0.6;margin-top:20px;">You will be matched with a player who selected the same arena size.</p>
        <button class="btn battle" onclick="startBattleSearch()">‚öî FIND OPPONENT</button>
    </div>

    <div id="battle-search" class="box popup-box">
        <button class="close-btn" onclick="cancelBattleSearch()">X</button>
        <h2>‚öî SEARCHING...</h2>
        <div class="searching-animation">
            <div class="searching-dot"></div>
            <div class="searching-dot"></div>
            <div class="searching-dot"></div>
        </div>
        <p id="search-status">Looking for opponent...</p>
        <p style="font-size:12px;opacity:0.6;margin-top:20px;">Arena: <span id="search-arena">20x20</span></p>
        <button class="btn danger" onclick="cancelBattleSearch()" style="margin-top:20px;">CANCEL</button>
    </div>

    <div id="game-ui">
        <div id="battle-timer" style="display:none;">60</div>
        <div id="opponent-score" style="display:none;">VS: <span id="opp-name">???</span> - <span id="opp-score">0</span></div>
        SCORE: <span id="score-val">0</span>
        <div id="score-pop">+10</div>
        <div id="coin-pop">+10</div>
    </div>
    <div id="game-container"><canvas id="game" width="600" height="600"></canvas></div>

    <div id="dev-modal" class="box popup-box" style="width: 880px; max-width: 95vw; height: 80vh; display: none; z-index: 3000;">
        <button class="close-btn" onclick="hideDevPanel()">X</button>
        <h2 style="color:#0f0;">DEV CONTROL</h2>
        <div class="dev-tabs">
            <button class="dev-tab active" onclick="switchDevTab('dev-analytics')">ANALYTICS</button>
            <button class="dev-tab" onclick="switchDevTab('dev-accounts')">ACCOUNTS</button>
            <button class="dev-tab" onclick="switchDevTab('dev-game')">IN-GAME</button>
            <button class="dev-tab" onclick="switchDevTab('dev-bans')" style="color:#f00;border-color:#f00;">BAN</button>
        </div>
        <div id="dev-analytics" class="dev-content">
            <div class="dev-stat-row">
                <div class="dev-stat-card">
                    <div class="val" id="dev-total-users">0</div>
                    <div class="label">Total Users</div>
                </div>
                <div class="dev-stat-card">
                    <div class="val" id="dev-online">0</div>
                    <div class="label">Online Now</div>
                </div>
                <div class="dev-stat-card">
                    <div class="val" id="dev-battles">0</div>
                    <div class="label">Active Battles</div>
                </div>
            </div>
            <h3>Server</h3>
            <div style="background:#001500;padding:15px;border-radius:10px;font-family:monospace;color:#0f0;">
                <div>Firebase: <span id="dev-fb-status">INIT...</span></div>
                <div>Latency: <span id="dev-latency">...</span> ms</div>
            </div>
        </div>
        <div id="dev-accounts" class="dev-content" style="display:none;">
            <input type="text" id="dev-search" placeholder="Search user by name or email..." onkeyup="filterDevUsers()" style="width:100%;margin-bottom:10px;">
            <div class="dev-user-list" id="dev-user-list"></div>
        </div>
        <div id="dev-bans" class="dev-content" style="display:none;">
            <input type="text" id="dev-ban-search" placeholder="Search user..." onkeyup="filterBanList()" style="width:100%;margin-bottom:10px;border-color:#f00;color:#f00;">
            <div class="dev-user-list" id="dev-ban-list"></div>
        </div>
        <div id="dev-game" class="dev-content" style="display:none;">
            <h3>God Mode</h3>
            <label class="custom-check">
                <input type="checkbox" onchange="toggleGodMode(this)">
                <span class="check-circle"></span>
                Invincibility
            </label>
            <h3 style="margin-top:20px;">Game Control</h3>
            <button class="btn small" onclick="devSpawnBonus()">Spawn Bonus</button>
            <button class="btn small" onclick="devAddScore()">+100 Score</button>
            <button class="btn small" onclick="devWinBattle()">Force Win Battle</button>
        </div>
    </div>

    <div id="dev-notification-modal" class="box popup-box" style="z-index: 3100; display:none; width:460px;">
        <button class="close-btn" onclick="document.getElementById('dev-notification-modal').style.display='none'">X</button>
        <h2>SEND NOTIFICATION</h2>
        <p>To: <span id="notif-target-name" style="color:gold;"></span></p>
        <textarea id="dev-notif-text" style="width:100%;height:100px;background:#001500;border:2px solid #0f0;color:#0f0;padding:10px;margin:15px 0;" placeholder="Message..."></textarea>
        <button class="btn small" onclick="sendDevNotification()">SEND</button>
    </div>

    <div id="ban-confirm-modal" class="box popup-box" style="z-index: 3100; display:none; width:460px;border-color:#f00;">
        <button class="close-btn" onclick="closeBanModal()">X</button>
        <h2 style="color:#f00">BAN USER</h2>
        <p>Target: <span id="ban-target-name" style="color:#fff"></span></p>
        <div class="option">
            <label style="color:#f00">Reason:</label>
            <input type="text" id="ban-reason" placeholder="Cheating, toxicity, etc..." style="border-color:#f00;color:#f00;">
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="btn" onclick="closeBanModal()">CANCEL</button>
            <button class="btn danger" onclick="executeBan()" id="ban-confirm-btn">CONFIRM BAN</button>
        </div>
    </div>

    <div id="banned-screen">
        <h1 style="font-size:80px;margin-bottom:20px;text-shadow:0 0 50px #f00;">YOU ARE BANNED</h1>
        <div style="font-size:24px;color:#fff;margin-bottom:40px;">Reason: <span id="ban-reason-display" style="color:#f00;font-weight:bold;"></span></div>
        <div style="font-size:14px;opacity:0.5;">Contact support if you think this is a mistake.</div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDuy71JU0c_Igqs0QQmpKSQehY6mW8tE0U",
        authDomain: "lumisnake.firebaseapp.com",
        databaseURL: "https://lumisnake-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "lumisnake",
        storageBucket: "lumisnake.firebasestorage.app",
        messagingSenderId: "846397438816",
        appId: "1:846397438816:web:d36f7fc099f8162e067c05"
    };

    let app, auth, database;
    let currentUser = null;
    let userProfile = null;
    let firebaseReady = false;
    let viewingProfileId = null;

    const DEV_EMAIL = 'artemkirsanov1320@gmail.com';
    let isDev = false;
    let godMode = false;
    let presenceRef = null;
    let banStatusListenerSet = false;
    let currentUserBanRef = null;

    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        database = firebase.database();
        firebaseReady = true;
    } catch (e) {
        console.error("Firebase init error:", e);
    }

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;
    let soundVolume = 0.7;
    let musicVolume = 0.5;
    let musicPlaying = false;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playSound(type) {
        if (!audioCtx || soundVolume === 0) return;
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        gain.gain.setValueAtTime(soundVolume * 0.3, now);
        
        switch(type) {
            case 'eat':
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
                break;
            case 'bonus':
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.15);
                osc.frequency.exponentialRampToValueAtTime(1400, now + 0.3);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
                osc.start(now); osc.stop(now + 0.35);
                break;
            case 'crash':
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(soundVolume * 0.5, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
                break;
            case 'hover':
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(soundVolume * 0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now); osc.stop(now + 0.05);
                break;
            case 'click':
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.05);
                gain.gain.setValueAtTime(soundVolume * 0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.08);
                osc.start(now); osc.stop(now + 0.08);
                break;
            case 'close':
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
                osc.start(now); osc.stop(now + 0.12);
                break;
            case 'record':
                playFanfare(); return;
            case 'first':
                playFirstPlaceSound(); return;
            case 'login':
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523, now);
                gain.gain.exponentialRampToValueAtTime(soundVolume * 0.2, now + 0.1);
                osc.start(now);
                setTimeout(() => {
                    const o2 = audioCtx.createOscillator(), g2 = audioCtx.createGain();
                    o2.connect(g2); g2.connect(audioCtx.destination);
                    o2.type = 'sine'; o2.frequency.setValueAtTime(659, audioCtx.currentTime);
                    g2.gain.setValueAtTime(soundVolume * 0.2, audioCtx.currentTime);
                    g2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                    o2.start(); o2.stop(audioCtx.currentTime + 0.2);
                }, 100);
                setTimeout(() => {
                    const o3 = audioCtx.createOscillator(), g3 = audioCtx.createGain();
                    o3.connect(g3); g3.connect(audioCtx.destination);
                    o3.type = 'sine'; o3.frequency.setValueAtTime(784, audioCtx.currentTime);
                    g3.gain.setValueAtTime(soundVolume * 0.2, audioCtx.currentTime);
                    g3.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    o3.start(); o3.stop(audioCtx.currentTime + 0.3);
                }, 200);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.stop(now + 0.15);
                break;
            case 'victory':
                playVictorySound(); return;
            case 'defeat':
                playDefeatSound(); return;
            case 'countdown':
                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, now);
                gain.gain.setValueAtTime(soundVolume * 0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
                break;
            case 'battle-start':
                osc.type = 'square';
                osc.frequency.setValueAtTime(880, now);
                gain.gain.setValueAtTime(soundVolume * 0.4, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
                break;
        }
    }

    function playFanfare() {
        if (!audioCtx) return;
        [523, 659, 784, 1047].forEach((freq, i) => {
            setTimeout(() => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.type = 'sine'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(soundVolume * 0.25, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                o.start(); o.stop(audioCtx.currentTime + 0.4);
            }, i * 150);
        });
    }

    function playFirstPlaceSound() {
        if (!audioCtx) return;
        [523, 659, 784, 1047, 1319].forEach((freq) => {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(soundVolume * 0.15, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1);
            o.start(); o.stop(audioCtx.currentTime + 1);
        });
    }

    function playVictorySound() {
        if (!audioCtx) return;
        [523, 659, 784, 1047, 1319, 1568].forEach((freq, i) => {
            setTimeout(() => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.type = 'sine'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(soundVolume * 0.3, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                o.start(); o.stop(audioCtx.currentTime + 0.5);
            }, i * 100);
        });
    }

    function playDefeatSound() {
        if (!audioCtx) return;
        [400, 350, 300, 250].forEach((freq, i) => {
            setTimeout(() => {
                const o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.type = 'sawtooth'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
                g.gain.setValueAtTime(soundVolume * 0.2, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                o.start(); o.stop(audioCtx.currentTime + 0.3);
            }, i * 150);
        });
    }

    function createBackgroundMusic() {
        if (!audioCtx) return;
        const bassNotes = [130.81, 146.83, 164.81, 174.61];
        let noteIndex = 0;
        function playNote() {
            if (!musicPlaying || musicVolume === 0) return;
            const o = audioCtx.createOscillator(), g = audioCtx.createGain(), f = audioCtx.createBiquadFilter();
            o.connect(f); f.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine'; f.type = 'lowpass'; f.frequency.setValueAtTime(400, audioCtx.currentTime);
            o.frequency.setValueAtTime(bassNotes[noteIndex % bassNotes.length], audioCtx.currentTime);
            g.gain.setValueAtTime(musicVolume * 0.15, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
            o.start(); o.stop(audioCtx.currentTime + 0.5);
            noteIndex++;
            if (musicPlaying) setTimeout(playNote, 500);
        }
        playNote();
    }

    function toggleMusic() {
        initAudio();
        musicPlaying = !musicPlaying;
        const btn = document.getElementById('music-toggle');
        if (musicPlaying) {
            btn.classList.remove('muted'); btn.innerHTML = 'üéµ';
            createBackgroundMusic();
        } else {
            btn.classList.add('muted'); btn.innerHTML = 'üîá';
        }
    }

    function updateMusicVolume(vol) { musicVolume = vol / 100; localStorage.setItem('lumisnake_musicvol', musicVolume); }
    function updateSoundVolume(vol) { soundVolume = vol / 100; localStorage.setItem('lumisnake_soundvol', soundVolume); }

    soundVolume = parseFloat(localStorage.getItem('lumisnake_soundvol')) || 0.7;
    musicVolume = parseFloat(localStorage.getItem('lumisnake_musicvol')) || 0.5;

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
    const bg = document.getElementById('bg'), bctx = bg.getContext('2d');
    const scorePop = document.getElementById('score-pop');
    const coinPop = document.getElementById('coin-pop');
    let GRID = 25, CELL, snake = [], dir = {x:1,y:0}, nextDir = {x:1,y:0}, foods = [], bonuses = [], score = 0;
    let speed = 80, lastTime = 0, gameActive = false, settings = {};
    let localHighScore = parseInt(localStorage.getItem('lumisnake_highscore')) || 0;
    let coins = parseInt(localStorage.getItem('lumisnake_coins')) || 0;
    let trophies = parseInt(localStorage.getItem('lumisnake_trophies')) || 0;
    let ownedSkins = JSON.parse(localStorage.getItem('lumisnake_skins')) || ['classic'];
    let selectedSkin = localStorage.getItem('lumisnake_selected') || 'classic';
    let localUsername = localStorage.getItem('lumisnake_username') || 'Player';

    let isBattleMode = false;
    let battleId = null;
    let battleTimer = 60;
    let battleTimerInterval = null;
    let opponentScore = 0;
    let opponentName = '';
    let searchingForBattle = false;
    let matchmakingRef = null;
    let battleRef = null;

    const skins = [
        { id: 'classic', name: 'CLASSIC', color: '#00ff00', price: 0 },
        { id: 'cyan', name: 'CYBER', color: '#00ffff', price: 500 },
        { id: 'pink', name: 'NEON PINK', color: '#ff00ff', price: 500 },
        { id: 'blue', name: 'OCEAN', color: '#0088ff', price: 750 },
        { id: 'red', name: 'FIRE', color: '#ff3300', price: 1000 },
        { id: 'orange', name: 'SUNSET', color: '#ff8800', price: 1200 },
        { id: 'gold', name: 'GOLDEN', color: '#ffd700', price: 2000 },
        { id: 'purple', name: 'MYSTIC', color: '#aa00ff', price: 2500 },
        { id: 'crimson', name: 'CRIMSON', color: '#dc143c', price: 3000 },
        { id: 'ghost', name: 'GHOST', color: '#ffffff', price: 5000 },
        { id: 'plasma', name: 'PLASMA', color: '#00ff88', price: 7500 },
        { id: 'rainbow', name: 'RAINBOW', color: 'rainbow', price: 10000 }
    ];

    function saveData() {
        localStorage.setItem('lumisnake_coins', coins);
        localStorage.setItem('lumisnake_skins', JSON.stringify(ownedSkins));
        localStorage.setItem('lumisnake_selected', selectedSkin);
        localStorage.setItem('lumisnake_highscore', localHighScore);
        localStorage.setItem('lumisnake_trophies', trophies);
        if (currentUser && database && firebaseReady) {
            database.ref('users/' + currentUser.uid).update({
                coins, ownedSkins, selectedSkin, highScore: localHighScore, trophies
            });
        }
    }

    function updateCoinDisplay() { document.getElementById('coin-count').innerText = coins.toLocaleString(); }
    function showCoinDisplay(show) { document.getElementById('coin-display').classList.toggle('hidden', !show); }
    function showUserDisplay(show) { document.getElementById('user-display').classList.toggle('hidden', !show); }
    function showLeaderboardBtn(show) { document.getElementById('leaderboard-btn').classList.toggle('hidden', !show); }
    function showMusicToggle(show) { document.getElementById('music-toggle').classList.toggle('hidden', !show); }

    function updateUserDisplay() {
        const avatar = document.getElementById('user-avatar');
        const name = document.getElementById('user-name');
        if (currentUser) {
            avatar.innerHTML = currentUser.photoURL ? 
                `<img src="${currentUser.photoURL}" class="user-avatar" style="width:100%;height:100%;">` : 'üë§';
            name.innerText = userProfile?.username || currentUser.displayName || 'User';
        } else {
            avatar.innerHTML = 'üë§';
            name.innerText = localUsername;
        }
        updateMessageBadge();
    }

    async function updateMessageBadge() {
        if (!currentUser || !database || !firebaseReady) {
            document.getElementById('msg-badge').classList.add('hidden');
            return;
        }
        const snapshot = await database.ref('messages/' + currentUser.uid).orderByChild('read').equalTo(false).once('value');
        const count = snapshot.numChildren();
        const badge = document.getElementById('msg-badge');
        const btnCount = document.getElementById('msg-count-btn');
        if (count > 0) {
            badge.innerText = count; badge.classList.remove('hidden');
            if (btnCount) btnCount.innerText = `(${count})`;
        } else {
            badge.classList.add('hidden');
            if (btnCount) btnCount.innerText = '';
        }
    }

    updateCoinDisplay();
    showUserDisplay(true);
    updateUserDisplay();

    function signInWithGoogle() {
        if (!auth || !firebaseReady) { showToast('Firebase not available', 'gold'); return; }
        playSound('click');
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
            .then(() => { playSound('login'); showToast('Account connected!', 'success'); loadUserData(); })
            .catch((e) => { console.error('Sign in error:', e); showToast('Sign in failed', 'gold'); });
    }

    function signOutUser() {
        playSound('click');
        if (auth && firebaseReady) {
            auth.signOut().then(() => {
                currentUser = null;
                userProfile = null;
                coins = 0;
                localHighScore = 0;
                trophies = 0;
                ownedSkins = ['classic'];
                selectedSkin = 'classic';
                localStorage.removeItem('lumisnake_coins');
                localStorage.removeItem('lumisnake_highscore');
                localStorage.removeItem('lumisnake_trophies');
                localStorage.removeItem('lumisnake_skins');
                localStorage.removeItem('lumisnake_selected');
                updateCoinDisplay();
                updateAuthUI();
                updateUserDisplay();
                showToast('Logged out', 'success');
            });
        }
    }

    function loadUserData() {
        if (!currentUser || !database || !firebaseReady) return;
        database.ref('users/' + currentUser.uid).once('value').then((snapshot) => {
            const data = snapshot.val();
            if (data) {
                userProfile = data;
                coins = data.coins || 0;
                localHighScore = data.highScore || 0;
                trophies = data.trophies || 0;
                ownedSkins = data.ownedSkins || ['classic'];
                selectedSkin = data.selectedSkin || 'classic';
                if (!ownedSkins.includes('classic')) ownedSkins.unshift('classic');
                saveData();
                updateCoinDisplay();
            } else {
                coins = 0;
                localHighScore = 0;
                trophies = 0;
                ownedSkins = ['classic'];
                selectedSkin = 'classic';
                userProfile = {
                    username: currentUser.displayName || 'Player',
                    description: '',
                    hideEmail: false,
                    email: currentUser.email,
                    coins: 0,
                    highScore: 0,
                    trophies: 0,
                    ownedSkins: ['classic'],
                    selectedSkin: 'classic',
                    createdAt: Date.now()
                };
                database.ref('users/' + currentUser.uid).set(userProfile);
                saveData();
                updateCoinDisplay();
            }
            updateUserDisplay();
            updateAuthUI();
        });
    }

    function saveProfile() {
        const nickname = document.getElementById('profile-nickname').value.trim();
        const description = document.getElementById('profile-description').value.trim();
        const hideEmail = document.getElementById('profile-hide-email').checked;
        if (nickname.length < 2) { showToast('Nickname must be at least 2 characters!', 'gold'); return; }
        playSound('click');
        if (currentUser && database && firebaseReady) {
            userProfile = userProfile || {};
            userProfile.username = nickname;
            userProfile.description = description;
            userProfile.hideEmail = hideEmail;
            database.ref('users/' + currentUser.uid).update({ username: nickname, description, hideEmail });
            database.ref('leaderboard/' + currentUser.uid).update({ name: nickname, hideEmail, trophies });
        }
        localUsername = nickname;
        localStorage.setItem('lumisnake_username', nickname);
        updateUserDisplay();
        showToast('Profile saved!', 'success');
    }

    function loadProfileForm() {
        if (userProfile) {
            document.getElementById('profile-nickname').value = userProfile.username || '';
            document.getElementById('profile-description').value = userProfile.description || '';
            document.getElementById('profile-hide-email').checked = userProfile.hideEmail || false;
            document.getElementById('my-high-score').innerText = (userProfile.highScore || localHighScore).toLocaleString();
            document.getElementById('my-trophies').innerText = (userProfile.trophies || trophies).toLocaleString();
            document.getElementById('my-coins').innerText = coins.toLocaleString();
        }
    }

    function updateAuthUI() {
        const loggedOut = document.getElementById('auth-logged-out');
        const loggedIn = document.getElementById('auth-logged-in');
        if (currentUser) {
            loggedOut.style.display = 'none'; loggedIn.style.display = 'block';
            document.getElementById('auth-avatar').src = currentUser.photoURL || '';
            document.getElementById('auth-email').innerText = currentUser.email;
            document.getElementById('auth-username').innerText = userProfile?.username || currentUser.displayName;
            loadProfileForm();
        } else {
            loggedOut.style.display = 'block'; loggedIn.style.display = 'none';
        }
    }

    if (auth && firebaseReady) {
        auth.onAuthStateChanged((user) => {
            currentUser = user;
            isDev = !!(user && user.email === DEV_EMAIL);
            if (presenceRef) {
                presenceRef.remove();
                presenceRef = null;
            }
            if (currentUserBanRef) {
                currentUserBanRef.off();
                currentUserBanRef = null;
            }

            if (user) {
                loadUserData();
                setupPresence();
                setupBanWatcher();
            } else {
                userProfile = null;
                updateAuthUI();
                updateUserDisplay();
                hideDevPanel();
                document.getElementById('banned-screen').style.display = 'none';
            }
        });
    }

    function setupPresence() {
        if (!database || !currentUser) return;
        presenceRef = database.ref('presence/' + currentUser.uid);
        presenceRef.set({ online: true, lastSeen: Date.now() });
        presenceRef.onDisconnect().set({ online: false, lastSeen: Date.now() });
    }

    function setupBanWatcher() {
        if (!database || !currentUser) return;
        currentUserBanRef = database.ref('bans/' + currentUser.uid);
        currentUserBanRef.on('value', snap => {
            const data = snap.val();
            if (data && data.active) {
                const reason = data.reason || 'No reason provided';
                document.getElementById('ban-reason-display').innerText = reason;
                document.getElementById('banned-screen').style.display = 'flex';
            } else {
                document.getElementById('banned-screen').style.display = 'none';
            }
        });
    }

    function showDevPanel() {
        if (!isDev) return;
        hideAll();
        showCoinDisplay(false); showUserDisplay(true); showLeaderboardBtn(false); showMusicToggle(true);
        document.getElementById('dev-modal').style.display = 'block';
        loadDevAnalytics();
        loadDevAccounts();
        loadBanList();
    }

    function hideDevPanel() {
        const m = document.getElementById('dev-modal');
        if (m) m.style.display = 'none';
    }

    function switchDevTab(id) {
        document.querySelectorAll('#dev-modal .dev-tab').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('#dev-modal .dev-content').forEach(c => c.style.display = 'none');
        const btn = Array.from(document.querySelectorAll('#dev-modal .dev-tab')).find(b => b.getAttribute('onclick').includes(id));
        if (btn) btn.classList.add('active');
        const tab = document.getElementById(id);
        if (tab) tab.style.display = 'block';
    }

    async function loadDevAnalytics() {
        if (!database || !isDev) return;
        document.getElementById('dev-fb-status').innerText = firebaseReady ? 'CONNECTED' : 'ERROR';
        try {
            const usersSnap = await database.ref('users').once('value');
            document.getElementById('dev-total-users').innerText = usersSnap.numChildren();
            const presenceSnap = await database.ref('presence').orderByChild('online').equalTo(true).once('value');
            document.getElementById('dev-online').innerText = presenceSnap.numChildren();
            const battlesSnap = await database.ref('battles').orderByChild('status').equalTo('preparing').once('value');
            document.getElementById('dev-battles').innerText = battlesSnap.numChildren();
        } catch (e) {
            console.error('Dev analytics error', e);
        }

        const t0 = performance.now();
        try {
            await database.ref('.info/connected').once('value');
            const dt = Math.round(performance.now() - t0);
            document.getElementById('dev-latency').innerText = dt;
        } catch (e) {
            document.getElementById('dev-latency').innerText = 'ERR';
        }
    }

    async function loadDevAccounts() {
        if (!database || !isDev) return;
        const list = document.getElementById('dev-user-list');
        list.innerHTML = 'Loading...';
        const snap = await database.ref('users').limitToLast(200).once('value');
        const items = [];
        snap.forEach(c => {
            const d = c.val();
            if (!d) return;
            items.push({ id: c.key, ...d });
        });
        items.sort((a,b) => (b.highScore||0) - (a.highScore||0));
        list.innerHTML = items.map(u => {
            const nick = u.username || 'Player';
            const email = u.email || '';
            const coinsVal = u.coins || 0;
            const scoreVal = u.highScore || 0;
            const trophiesVal = u.trophies || 0;
            const statusId = 'status-' + u.id;
            return `
                <div class="dev-user-item" data-id="${u.id}" data-name="${nick.toLowerCase()}" data-email="${email.toLowerCase()}">
                    <div class="dev-user-header">
                        <div>
                            <span class="dev-user-name">${nick}</span>
                            <div class="dev-user-email">${email}</div>
                        </div>
                        <div class="profile-status" id="${statusId}">status...</div>
                    </div>
                    <div class="dev-user-fields">
                        <input type="number" value="${coinsVal}" data-field="coins" placeholder="Coins">
                        <input type="number" value="${scoreVal}" data-field="highScore" placeholder="Score">
                        <input type="number" value="${trophiesVal}" data-field="trophies" placeholder="Trophies">
                    </div>
                    <div class="dev-user-actions">
                        <button class="btn small" onclick="devSaveUser('${u.id}', this)">SAVE</button>
                        <button class="btn small" onclick="openDevNotification('${u.id}', '${nick.replace(/'/g, "\\'")}')">NOTIFY</button>
                    </div>
                </div>
            `;
        }).join('');

        const presSnap = await database.ref('presence').once('value');
        const pres = presSnap.val() || {};
        items.forEach(u => {
            const el = document.getElementById('status-' + u.id);
            if (!el) return;
            const p = pres[u.id];
            if (p && p.online) {
                el.textContent = 'online';
                el.classList.add('online');
                el.classList.remove('offline');
            } else {
                el.textContent = 'offline';
                el.classList.add('offline');
                el.classList.remove('online');
            }
        });
    }

    function filterDevUsers() {
        const q = document.getElementById('dev-search').value.toLowerCase();
        document.querySelectorAll('#dev-user-list .dev-user-item').forEach(it => {
            const name = it.getAttribute('data-name') || '';
            const email = it.getAttribute('data-email') || '';
            it.style.display = (name.includes(q) || email.includes(q)) ? 'block' : 'none';
        });
    }

    async function devSaveUser(uid, btn) {
        if (!database || !isDev) return;
        const item = btn.closest('.dev-user-item');
        const fields = item.querySelectorAll('input[data-field]');
        const data = {};
        fields.forEach(inp => { data[inp.dataset.field] = parseInt(inp.value) || 0; });
        await database.ref('users/' + uid).update(data);
        if (uid === (currentUser && currentUser.uid)) {
            coins = data.coins;
            localHighScore = data.highScore;
            trophies = data.trophies;
            saveData();
            updateCoinDisplay();
            loadProfileForm();
        }
        await database.ref('leaderboard/' + uid).update({ score: data.highScore, trophies: data.trophies });
        showToast('User updated', 'success');
    }

    function openDevNotification(uid, name) {
        const m = document.getElementById('dev-notification-modal');
        m.style.display = 'block';
        m.dataset.uid = uid;
        document.getElementById('notif-target-name').innerText = name;
        document.getElementById('dev-notif-text').value = '';
    }

    async function sendDevNotification() {
        if (!database || !isDev) return;
        const m = document.getElementById('dev-notification-modal');
        const uid = m.dataset.uid;
        const text = document.getElementById('dev-notif-text').value.trim();
        if (!uid || !text) return;
        await database.ref('messages/' + uid).push({
            fromId: currentUser.uid,
            fromName: '[SYSTEM]',
            text,
            timestamp: Date.now(),
            read: false
        });
        m.style.display = 'none';
        showToast('Notification sent', 'gold');
    }

    async function loadBanList() {
        if (!database || !isDev) return;
        const list = document.getElementById('dev-ban-list');
        list.innerHTML = 'Loading...';
        const usersSnap = await database.ref('users').limitToLast(200).once('value');
        const bansSnap = await database.ref('bans').once('value');
        const bans = bansSnap.val() || {};
        const items = [];
        usersSnap.forEach(c => {
            const d = c.val();
            if (!d) return;
            const ban = bans[c.key];
            items.push({ id: c.key, ...d, ban });
        });
        items.sort((a,b) => (a.username||'').localeCompare(b.username||''));
        list.innerHTML = items.map(u => {
            const nick = u.username || 'Player';
            const email = u.email || '';
            const active = !!(u.ban && u.ban.active);
            const reason = u.ban && u.ban.reason ? u.ban.reason : '';
            const statusText = active ? 'banned' : 'active';
            const statusColor = active ? '#f00' : '#0f0';
            const btnText = active ? 'UNBAN' : 'BAN';
            const btnClass = active ? '' : 'danger';
            return `
                <div class="dev-user-item" data-id="${u.id}" data-name="${nick.toLowerCase()}" data-email="${email.toLowerCase()}">
                    <div class="dev-user-header">
                        <div>
                            <span class="dev-user-name">${nick}</span>
                            <div class="dev-user-email">${email}</div>
                        </div>
                        <div style="font-size:11px;color:${statusColor}">${statusText}</div>
                    </div>
                    ${active && reason ? `<div style="font-size:11px;color:#faa;margin-top:4px;">Reason: ${reason}</div>` : ''}
                    <div class="dev-user-actions">
                        <button class="btn small ${btnClass}" onclick="toggleBanUser('${u.id}', '${nick.replace(/'/g, "\\'")}', ${active})">${btnText}</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function filterBanList() {
        const q = document.getElementById('dev-ban-search').value.toLowerCase();
        document.querySelectorAll('#dev-ban-list .dev-user-item').forEach(it => {
            const name = it.getAttribute('data-name') || '';
            const email = it.getAttribute('data-email') || '';
            it.style.display = (name.includes(q) || email.includes(q)) ? 'block' : 'none';
        });
    }

    let banTargetId = null;
    function toggleBanUser(uid, name, isBanned) {
        if (!isDev) return;
        if (isBanned) {
            database.ref('bans/' + uid).set({ active: false });
            showToast('User unbanned', 'success');
            loadBanList();
        } else {
            banTargetId = uid;
            document.getElementById('ban-target-name').innerText = name;
            document.getElementById('ban-reason').value = '';
            document.getElementById('ban-confirm-modal').style.display = 'block';
        }
    }

    function closeBanModal() {
        document.getElementById('ban-confirm-modal').style.display = 'none';
        banTargetId = null;
    }

    async function executeBan() {
        if (!database || !isDev || !banTargetId) return;
        const reason = document.getElementById('ban-reason').value.trim() || 'No reason provided';
        await database.ref('bans/' + banTargetId).set({
            active: true,
            reason,
            timestamp: Date.now(),
            by: currentUser.uid
        });
        closeBanModal();
        showToast('User banned', 'danger');
        loadBanList();
    }

    function toggleGodMode(chk) {
        godMode = chk.checked;
        showToast(godMode ? 'God mode ON' : 'God mode OFF', 'gold');
    }

    function devSpawnBonus() {
        if (!godMode) return;
        if (bonuses.length === 0) {
            bonuses.push({ x: Math.floor(Math.random()*GRID), y: Math.floor(Math.random()*GRID) });
        }
    }

    function devAddScore() {
        if (!godMode) return;
        score += 100;
        document.getElementById('score-val').innerText = score;
        if (isBattleMode) updateBattleScore();
    }

    function devWinBattle() {
        if (!godMode || !isBattleMode) return;
        opponentScore = 0;
        score = 999;
        endBattle();
    }

    function showMessages() {
        if (!currentUser) { showToast('Please sign in first', 'gold'); return; }
        playSound('click');
        hideAll();
        showCoinDisplay(true); showUserDisplay(true); showMusicToggle(true);
        loadMessages();
        document.getElementById('messages-modal').style.display = 'block';
    }

    function hideMessages() {
        playSound('close');
        showAuthModal();
    }

    async function loadMessages() {
        const list = document.getElementById('messages-list');
        if (!currentUser || !database) {
            list.innerHTML = '<p style="opacity:0.6;text-align:center;padding:40px;">Sign in to view messages</p>';
            return;
        }
        list.innerHTML = '<p style="opacity:0.6;text-align:center;padding:40px;">Loading...</p>';
        const snapshot = await database.ref('messages/' + currentUser.uid).orderByChild('timestamp').once('value');
        const messages = [];
        snapshot.forEach(child => messages.unshift({ id: child.key, ...child.val() }));
        
        if (messages.length === 0) {
            list.innerHTML = '<p style="opacity:0.6;text-align:center;padding:40px;">No messages yet</p>';
            return;
        }
        
        list.innerHTML = messages.map(msg => {
            const date = new Date(msg.timestamp).toLocaleDateString();
            return `
                <div class="message-item ${msg.read ? '' : 'unread'}" data-id="${msg.id}">
                    <div class="message-header">
                        <span class="message-from">${msg.fromName}</span>
                        <span class="message-date">${date}</span>
                    </div>
                    <div class="message-text">${escapeHtml(msg.text)}</div>
                    <div class="message-actions">
                        <button onclick="replyToMessage('${msg.fromId}', '${escapeHtml(msg.fromName)}')">Reply</button>
                        <button class="delete" onclick="deleteMessage('${msg.id}')">Delete</button>
                    </div>
                </div>
            `;
        }).join('');
        
        messages.filter(m => !m.read).forEach(msg => {
            database.ref('messages/' + currentUser.uid + '/' + msg.id).update({ read: true });
        });
        updateMessageBadge();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function replyToMessage(userId, userName) {
        playSound('click');
        viewingProfileId = userId;
        hideAll();
        showCoinDisplay(true); showUserDisplay(true); showMusicToggle(true);
        
        database.ref('users/' + userId).once('value').then(snapshot => {
            const userData = snapshot.val();
            database.ref('leaderboard/' + userId).once('value').then(lbSnapshot => {
                displayProfile(userId, userData, lbSnapshot.val());
            });
        });
    }

    async function deleteMessage(msgId) {
        playSound('click');
        await database.ref('messages/' + currentUser.uid + '/' + msgId).remove();
        showToast('Message deleted', 'success');
        loadMessages();
    }

    async function sendMessage() {
        if (!currentUser || !viewingProfileId) { showToast('Cannot send message', 'gold'); return; }
        const text = document.getElementById('compose-text').value.trim();
        if (!text) { showToast('Please write a message', 'gold'); return; }
        if (text.length > 500) { showToast('Message too long', 'gold'); return; }
        
        playSound('click');
        await database.ref('messages/' + viewingProfileId).push({
            fromId: currentUser.uid,
            fromName: userProfile?.username || currentUser.displayName,
            text,
            timestamp: Date.now(),
            read: false
        });
        
        document.getElementById('compose-text').value = '';
        showToast('Message sent!', 'success');
    }

    function loadLeaderboard() {
        const list = document.getElementById('leaderboard-list');
        if (!database || !firebaseReady) {
            list.innerHTML = `<div class="leaderboard-item gold">
                <span class="lb-rank gold">1</span>
                <div class="lb-avatar" style="display:flex;align-items:center;justify-content:center;">üë§</div>
                <div class="lb-info"><div class="lb-name">${localUsername} (You)</div></div>
                <span class="lb-score">${localHighScore.toLocaleString()}</span>
            </div>`;
            return;
        }
        list.innerHTML = '<p style="opacity:0.6;text-align:center;padding:40px;">Loading...</p>';
        database.ref('leaderboard').orderByChild('score').limitToLast(20).once('value').then((snapshot) => {
            const entries = [];
            snapshot.forEach(child => {
                const val = child.val();
                if (val && val.score !== undefined && val.name) {
                    entries.push({ id: child.key, ...val });
                }
            });
            entries.reverse();
            if (entries.length === 0) {
                list.innerHTML = '<p style="opacity:0.6;text-align:center;padding:40px;">No scores yet!</p>';
                return;
            }
            list.innerHTML = entries.map((e, i) => {
                const rank = i + 1;
                const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                const isMe = currentUser && e.id === currentUser.uid;
                const playerName = e.name || 'Player';
                const playerScore = e.score || 0;
                const playerTrophies = e.trophies || 0;
                return `
                    <div class="leaderboard-item ${rankClass}" onclick="viewProfile('${e.id}')" data-uid="${e.id}">
                        <span class="lb-rank ${rankClass}">${rank}</span>
                        <img class="lb-avatar" src="${e.photoURL || ''}" onerror="this.style.display='none'">
                        <div class="lb-info">
                            <div class="lb-name">${playerName}${isMe ? ' (You)' : ''}</div>
                            ${playerTrophies > 0 ? `<div class="lb-trophies">üèÜ ${playerTrophies} trophies</div>` : ''}
                        </div>
                        <span class="lb-score">${playerScore.toLocaleString()}</span>
                    </div>
                `;
            }).join('');
        }).catch(err => {
            console.error('Leaderboard error:', err);
            list.innerHTML = '<p style="opacity:0.6;text-align:center;padding:40px;">Error loading leaderboard</p>';
        });
    }

    async function updateLeaderboard(newScore) {
        if (newScore <= localHighScore) return;
        localHighScore = newScore;
        saveData();
        document.getElementById('record-score').innerText = newScore.toLocaleString();
        document.getElementById('new-record-overlay').classList.add('active');
        playSound('record');
        
        if (currentUser && database && firebaseReady) {
            try {
                await database.ref('leaderboard/' + currentUser.uid).set({
                    name: userProfile?.username || currentUser.displayName || 'Player',
                    score: newScore,
                    photoURL: currentUser.photoURL || '',
                    hideEmail: userProfile?.hideEmail || false,
                    trophies: trophies || 0
                });
                
                await database.ref('users/' + currentUser.uid).update({
                    highScore: newScore
                });
                
                const snapshot = await database.ref('leaderboard').orderByChild('score').limitToLast(1).once('value');
                let topScore = 0;
                snapshot.forEach(c => {
                    const val = c.val();
                    if (val && val.score) topScore = val.score;
                });
                if (newScore >= topScore) {
                    document.getElementById('first-place-msg').style.display = 'block';
                    setTimeout(() => playSound('first'), 500);
                }
            } catch (err) {
                console.error('Leaderboard update error:', err);
            }
        }
    }

    function closeRecordOverlay() {
        playSound('click');
        document.getElementById('new-record-overlay').classList.remove('active');
        document.getElementById('first-place-msg').style.display = 'none';
    }

    function viewProfile(uid) {
        if (!database || !firebaseReady) { showToast('Connect to view profiles', 'gold'); return; }
        playSound('click');
        viewingProfileId = uid;
        database.ref('users/' + uid).once('value').then(snapshot => {
            const userData = snapshot.val();
            if (!userData) { showToast('Profile not found', 'gold'); return; }
            database.ref('leaderboard/' + uid).once('value').then(lbSnapshot => {
                displayProfile(uid, userData, lbSnapshot.val());
            });
        });
    }

    function displayProfile(uid, userData, lbData) {
        hideAll();
        showCoinDisplay(true); showUserDisplay(true); showLeaderboardBtn(false); showMusicToggle(true);
        
        const avatarEl = document.getElementById('view-avatar');
        avatarEl.src = lbData?.photoURL || '';
        avatarEl.style.display = lbData?.photoURL ? 'block' : 'none';
        
        document.getElementById('view-nickname').innerText = userData.username || 'Player';
        const emailEl = document.getElementById('view-email');
        if (userData.hideEmail) {
            emailEl.innerText = 'üîí Email hidden'; emailEl.style.opacity = '0.5';
        } else {
            emailEl.innerText = userData.email || ''; emailEl.style.opacity = '0.7';
        }
        document.getElementById('view-description').innerText = userData.description || 'No description provided.';
        document.getElementById('view-score').innerText = (lbData?.score || userData.highScore || 0).toLocaleString();
        document.getElementById('view-trophies').innerText = (lbData?.trophies || userData.trophies || 0).toLocaleString();
        
        const createdAt = userData.createdAt;
        document.getElementById('view-created').innerText = createdAt ? 
            new Date(createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Unknown';
        
        const composeSection = document.getElementById('compose-section');
        if (currentUser && uid !== currentUser.uid) {
            composeSection.style.display = 'block';
            document.getElementById('compose-text').value = '';
        } else {
            composeSection.style.display = 'none';
        }
        
        document.getElementById('profile-view').style.display = 'block';
    }

    function hideProfileView() {
        playSound('close');
        viewingProfileId = null;
        showMainMenu();
    }

    function showBattleConfig() {
        if (!currentUser) { showToast('Please sign in to play battles!', 'gold'); return; }
        playSound('click');
        hideAll();
        showCoinDisplay(false); showUserDisplay(false); showLeaderboardBtn(false); showMusicToggle(false);
        document.getElementById('battle-config').style.display = 'block';
    }

    function hideBattleConfig() {
        playSound('close');
        showMainMenu();
    }

    function startBattleSearch() {
        if (!currentUser || !database) { showToast('Please sign in!', 'gold'); return; }
        playSound('click');
        const gridSize = document.getElementById('battle-grid-size').value;
        document.getElementById('search-arena').innerText = gridSize + 'x' + gridSize;
        
        hideAll();
        showCoinDisplay(false); showUserDisplay(false); showLeaderboardBtn(false); showMusicToggle(false);
        document.getElementById('battle-search').style.display = 'block';
        document.getElementById('search-status').innerText = 'Looking for opponent...';
        
        searchingForBattle = true;
        joinMatchmaking(gridSize);
    }

    async function joinMatchmaking(gridSize) {
        const queueRef = database.ref('matchmaking/' + gridSize);
        const myEntry = {
            oderId: currentUser.uid,
            playerName: userProfile?.username || currentUser.displayName || 'Player',
            timestamp: Date.now()
        };
        
        const snapshot = await queueRef.orderByChild('timestamp').limitToFirst(1).once('value');
        let opponent = null;
        snapshot.forEach(c => {
            const val = c.val();
            if (val.oderId && val.oderId !== currentUser.uid) {
                opponent = { oderId: val.oderId, playerName: val.playerName };
            }
        });
        
        if (opponent) {
            await queueRef.child(opponent.oderId).remove();
            const newBattleId = database.ref('battles').push().key;
            await database.ref('battles/' + newBattleId).set({
                player1: { oderId: opponent.oderId, name: opponent.playerName, score: 0 },
                player2: { oderId: currentUser.uid, name: userProfile?.username || currentUser.displayName || 'Player', score: 0 },
                gridSize: parseInt(gridSize),
                status: 'preparing',
                createdAt: Date.now()
            });
            startBattle(newBattleId, opponent.playerName, parseInt(gridSize));
        } else {
            matchmakingRef = queueRef.child(currentUser.uid);
            await matchmakingRef.set(myEntry);
            
            database.ref('battles').orderByChild('createdAt').limitToLast(10).on('child_added', async (bSnap) => {
                if (!searchingForBattle) return;
                const b = bSnap.val();
                if (b && b.status === 'preparing') {
                    if (b.player1.oderId === currentUser.uid || b.player2.oderId === currentUser.uid) {
                        searchingForBattle = false;
                        database.ref('battles').off();
                        queueRef.off();
                        if (matchmakingRef) matchmakingRef.remove();
                        const oppName = b.player1.oderId === currentUser.uid ? b.player2.name : b.player1.name;
                        startBattle(bSnap.key, oppName, b.gridSize);
                    }
                }
            });
        }
    }

    function cancelBattleSearch() {
        playSound('close');
        searchingForBattle = false;
        if (matchmakingRef) {
            matchmakingRef.remove();
            matchmakingRef = null;
        }
        try {
            const gridSize = document.getElementById('battle-grid-size').value;
            database.ref('matchmaking/' + gridSize).off();
            database.ref('battles').off();
        } catch (e) {}
        showMainMenu();
    }

    function startBattle(id, oppName, gridSize) {
        battleId = id;
        opponentName = oppName;
        isBattleMode = true;
        GRID = gridSize;
        
        document.getElementById('battle-search').style.display = 'none';
        document.getElementById('opponent-name').innerText = oppName;
        document.getElementById('battle-prep-overlay').classList.add('active');
        
        let prepTime = 20;
        document.getElementById('prep-timer').innerText = prepTime;
        
        const prepInterval = setInterval(() => {
            prepTime--;
            document.getElementById('prep-timer').innerText = prepTime;
            if (prepTime <= 3) playSound('countdown');
            if (prepTime <= 0) {
                clearInterval(prepInterval);
                document.getElementById('battle-prep-overlay').classList.remove('active');
                playSound('battle-start');
                launchBattle();
            }
        }, 1000);
    }

    function launchBattle() {
        CELL = 600 / GRID;
        score = 0;
        opponentScore = 0;
        battleTimer = 60;
        document.getElementById('score-val').innerText = score;
        document.getElementById('opp-name').innerText = opponentName;
        document.getElementById('opp-score').innerText = '0';
        
        snake = [{x:5,y:5},{x:4,y:5},{x:3,y:5}];
        dir = {x:1,y:0}; nextDir = {x:1,y:0};
        foods = []; bonuses = [];
        for (let i = 0; i < 3; i++) spawnFood();
        
        hideAll();
        showCoinDisplay(false); showUserDisplay(false); showLeaderboardBtn(false); showMusicToggle(false);
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('battle-timer').style.display = 'block';
        document.getElementById('battle-timer').innerText = '60';
        document.getElementById('opponent-score').style.display = 'block';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('game-container').classList.add('battle-mode');
        
        battleRef = database.ref('battles/' + battleId);
        let myPlayerKey = null;
        
        battleRef.child('player1').once('value').then(s => {
            const p1 = s.val();
            myPlayerKey = (p1 && p1.oderId === currentUser.uid) ? 'player1' : 'player2';
        });
        
        battleRef.on('value', snap => {
            const data = snap.val();
            if (!data || !myPlayerKey) return;
            const oppKey = myPlayerKey === 'player1' ? 'player2' : 'player1';
            opponentScore = data[oppKey]?.score || 0;
            document.getElementById('opp-score').innerText = opponentScore;
        });
        
        battleTimerInterval = setInterval(() => {
            battleTimer--;
            document.getElementById('battle-timer').innerText = battleTimer;
            if (battleTimer <= 10) document.getElementById('battle-timer').classList.add('warning');
            if (battleTimer <= 0) endBattle();
        }, 1000);
        
        gameActive = true;
        requestAnimationFrame(gameLoop);
    }

    async function updateBattleScore() {
        if (!battleId || !battleRef || !currentUser) return;
        try {
            const snap = await battleRef.child('player1').once('value');
            const p1 = snap.val();
            const playerKey = (p1 && p1.oderId === currentUser.uid) ? 'player1' : 'player2';
            await battleRef.child(playerKey).update({ score });
        } catch (e) {
            console.error('Battle score update error:', e);
        }
    }

    async function endBattle() {
        gameActive = false;
        clearInterval(battleTimerInterval);
        if (battleRef) battleRef.off();
        
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('battle-timer').style.display = 'none';
        document.getElementById('opponent-score').style.display = 'none';
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('game-container').classList.remove('battle-mode');
        document.getElementById('battle-timer').classList.remove('warning');
        
        const won = score > opponentScore;
        const draw = score === opponentScore;
        
        const resultTitle = document.getElementById('result-title');
        const resultScores = document.getElementById('result-scores');
        const resultReward = document.getElementById('result-reward');
        
        resultScores.innerText = `You: ${score} vs ${opponentName}: ${opponentScore}`;
        
        if (draw) {
            resultTitle.innerText = 'ü§ù DRAW!';
            resultTitle.className = 'overlay-title gold';
            resultReward.innerText = 'No rewards for a draw';
            playSound('close');
        } else if (won) {
            resultTitle.innerText = 'üèÜ VICTORY!';
            resultTitle.className = 'overlay-title green';
            trophies++;
            coins += 500;
            resultReward.innerText = '+1 üèÜ Trophy  +500 Coins';
            playSound('victory');
            saveData();
            updateCoinDisplay();
            if (currentUser && database) {
                database.ref('users/' + currentUser.uid).update({ trophies });
                database.ref('leaderboard/' + currentUser.uid).update({ trophies });
            }
        } else {
            resultTitle.innerText = 'üíÄ DEFEAT';
            resultTitle.className = 'overlay-title red';
            resultReward.innerText = 'Better luck next time!';
            playSound('defeat');
        }
        
        document.getElementById('battle-result-overlay').classList.add('active');
        
        if (battleId) {
            database.ref('battles/' + battleId).update({ status: 'finished' });
        }
        isBattleMode = false;
        battleId = null;
    }

    function closeBattleResult() {
        playSound('click');
        document.getElementById('battle-result-overlay').classList.remove('active');
        showMainMenu();
    }

    let particles = Array(50).fill().map(() => ({ 
        x: Math.random()*window.innerWidth, 
        y: window.innerHeight+50, 
        s: Math.random()*12+6, 
        v: Math.random()*2.5+1 
    }));
    
    function drawBg() {
        bg.width = window.innerWidth; bg.height = window.innerHeight;
        particles.forEach((p, i) => {
            p.y -= p.v;
            let prg = (p.y - bg.height/2) / (bg.height/2);
            if (p.y < bg.height/2) {
                particles[i] = { x: Math.random()*bg.width, y: bg.height+50, s: Math.random()*12+6, v: Math.random()*2.5+1 };
            } else {
                bctx.fillStyle = `rgba(0,255,0,${prg*0.5})`;
                bctx.beginPath(); bctx.arc(p.x, p.y, prg*p.s, 0, 7); bctx.fill();
            }
        });
        requestAnimationFrame(drawBg);
    }
    drawBg();

    function hideAll() {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('settings-menu').style.display = 'none';
        document.getElementById('audio-settings').style.display = 'none';
        document.getElementById('skins-menu').style.display = 'none';
        document.getElementById('leaderboard-menu').style.display = 'none';
        document.getElementById('auth-modal').style.display = 'none';
        document.getElementById('profile-view').style.display = 'none';
        document.getElementById('messages-modal').style.display = 'none';
        document.getElementById('battle-config').style.display = 'none';
        document.getElementById('battle-search').style.display = 'none';
    }

    function showMainMenu() {
        hideAll();
        showCoinDisplay(true); showUserDisplay(true); showLeaderboardBtn(true); showMusicToggle(true);
        document.getElementById('main-menu').style.display = 'flex';
    }

    function showSettings() { 
        playSound('click'); hideAll();
        showCoinDisplay(false); showUserDisplay(false); showLeaderboardBtn(false); showMusicToggle(false);
        document.getElementById('settings-menu').style.display = 'block'; 
    }
    function hideSettings() { playSound('close'); showMainMenu(); }

    function showAudioSettings() {
        playSound('click'); hideAll();
        showCoinDisplay(true); showUserDisplay(true); showLeaderboardBtn(false); showMusicToggle(true);
        document.getElementById('audio-settings').style.display = 'block';
    }
    function hideAudioSettings() { playSound('close'); showMainMenu(); }

    function showSkins() {
        playSound('click'); hideAll();
        showCoinDisplay(true); showUserDisplay(true); showLeaderboardBtn(false); showMusicToggle(true);
        renderSkins();
        document.getElementById('skins-menu').style.display = 'block';
    }
    function hideSkins() { playSound('close'); showMainMenu(); }

    function showLeaderboard() {
        playSound('click'); hideAll();
        showCoinDisplay(true); showUserDisplay(true); showLeaderboardBtn(false); showMusicToggle(true);
        loadLeaderboard();
        document.getElementById('leaderboard-menu').style.display = 'block';
    }
    function hideLeaderboard() { playSound('close'); showMainMenu(); }

    function showAuthModal() {
        playSound('click'); hideAll();
        showCoinDisplay(true); showUserDisplay(false); showLeaderboardBtn(false); showMusicToggle(true);
        updateAuthUI();
        document.getElementById('auth-modal').style.display = 'block';
    }
    function hideAuthModal() { playSound('close'); showMainMenu(); }

    function renderSkins() {
        const grid = document.getElementById('skins-grid');
        grid.innerHTML = '';
        skins.forEach(skin => {
            const owned = ownedSkins.includes(skin.id);
            const selected = selectedSkin === skin.id;
            const canBuy = coins >= skin.price;
            const card = document.createElement('div');
            card.className = 'skin-card' + (owned ? ' owned' : '') + (selected ? ' selected' : '') + (!owned && !canBuy ? ' locked' : '');
            
            let btnText, btnClass, btnDisabled = false;
            if (selected) { btnText = 'EQUIPPED'; btnClass = 'skin-btn selected-btn'; }
            else if (owned) { btnText = 'SELECT'; btnClass = 'skin-btn owned-btn'; }
            else { btnText = 'BUY'; btnClass = 'skin-btn'; btnDisabled = !canBuy; }

            let previewStyle = `background: ${skin.color}; color: ${skin.color};`;
            if (skin.id === 'rainbow') previewStyle = 'background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet); color: white;';

            card.innerHTML = `
                <div class="skin-preview"><div class="skin-line" style="${previewStyle}"></div></div>
                <div class="skin-name">${skin.name}</div>
                ${!owned ? `<div class="skin-price"><div class="mini-coin"></div>${skin.price.toLocaleString()}</div>` : '<div class="skin-price" style="color:#0f0;">OWNED</div>'}
                <button class="${btnClass}" ${btnDisabled ? 'disabled' : ''} data-id="${skin.id}">${btnText}</button>
            `;
            grid.appendChild(card);
        });
        grid.querySelectorAll('button').forEach(btn => btn.onclick = () => handleSkinAction(btn.dataset.id));
    }

    function handleSkinAction(skinId) {
        const skin = skins.find(s => s.id === skinId);
        if (!skin) return;
        playSound('click');
        if (ownedSkins.includes(skinId)) {
            selectedSkin = skinId;
            showToast(`${skin.name} equipped!`, 'success');
        } else if (coins >= skin.price) {
            coins -= skin.price;
            ownedSkins.push(skinId);
            selectedSkin = skinId;
            updateCoinDisplay();
            showToast(`${skin.name} purchased!`, 'gold');
        }
        saveData();
        renderSkins();
    }

    function initSlider(sliderId, valId, initialVal, onChange) {
        const track = document.getElementById(sliderId);
        const fill = track.querySelector('.slider-fill');
        const handle = track.querySelector('.slider-handle');
        const valDisplay = document.getElementById(valId);
        let dragging = false;

        function update(percent) {
            percent = Math.max(0, Math.min(100, percent));
            fill.style.width = percent + '%';
            handle.style.left = percent + '%';
            valDisplay.innerText = Math.round(percent) + '%';
            if (onChange) onChange(percent);
        }

        function getPercent(e) {
            const rect = track.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            return (x / rect.width) * 100;
        }

        track.addEventListener('mousedown', e => { dragging = true; update(getPercent(e)); });
        document.addEventListener('mousemove', e => { if (dragging) update(getPercent(e)); });
        document.addEventListener('mouseup', () => dragging = false);
        track.addEventListener('touchstart', e => { dragging = true; update(getPercent(e)); });
        document.addEventListener('touchmove', e => { if (dragging) update(getPercent(e)); });
        document.addEventListener('touchend', () => dragging = false);
        update(initialVal);
    }

    initSlider('sound-slider', 'sound-val', soundVolume * 100, updateSoundVolume);
    initSlider('music-slider', 'music-val', musicVolume * 100, updateMusicVolume);

    document.querySelectorAll('.btn, .skin-btn, #leaderboard-btn, #user-display').forEach(btn => {
        btn.addEventListener('mouseenter', () => playSound('hover'));
    });

    function triggerPop() {
        scorePop.classList.remove('pop-active');
        void scorePop.offsetWidth;
        scorePop.classList.add('pop-active');
    }

    function triggerCoinPop(amount) {
        coinPop.innerText = '+' + amount;
        coinPop.classList.remove('coin-pop-active');
        void coinPop.offsetWidth;
        coinPop.classList.add('coin-pop-active');
    }

    function runGame() {
        playSound('click');
        initAudio();
        isBattleMode = false;
        GRID = parseInt(document.getElementById('grid-size').value);
        settings.noWalls = document.getElementById('no-walls').checked;
        settings.bonuses = document.getElementById('allow-bonuses').checked;
        CELL = 600 / GRID;
        score = 0;
        document.getElementById('score-val').innerText = score;
        snake = [{x:5,y:5},{x:4,y:5},{x:3,y:5}];
        dir = {x:1,y:0}; nextDir = {x:1,y:0};
        foods = []; bonuses = [];
        for (let i = 0; i < parseInt(document.getElementById('apple-count').value); i++) spawnFood();
        hideAll();
        showCoinDisplay(false); showUserDisplay(false); showLeaderboardBtn(false); showMusicToggle(false);
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('battle-timer').style.display = 'none';
        document.getElementById('opponent-score').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        document.getElementById('game-container').classList.remove('battle-mode');
        gameActive = true;
        requestAnimationFrame(gameLoop);
    }

    function spawnFood() {
        let f = {x:Math.floor(Math.random()*GRID), y:Math.floor(Math.random()*GRID)};
        if (snake.some(s => s.x === f.x && s.y === f.y)) return spawnFood();
        foods.push(f);
        if (!isBattleMode && settings.bonuses && Math.random() > 0.85 && bonuses.length === 0) {
            bonuses.push({x:Math.floor(Math.random()*GRID), y:Math.floor(Math.random()*GRID)});
        }
    }

    function gameLoop(now) {
        if (!gameActive) return;
        requestAnimationFrame(gameLoop);
        if (now - lastTime < speed) return;
        lastTime = now;
        update();
        render();
    }

    function endGame(hitWall = false) {
        gameActive = false;
        if (hitWall) playSound('crash');
        if (!isBattleMode) {
            updateLeaderboard(score);
            saveData();
            updateCoinDisplay();
        }
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('game-container').style.display = 'none';
        showMainMenu();
    }

    function update() {
        dir = nextDir;
        let head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
        
        if (isBattleMode || !settings.noWalls) {
            if (head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID) {
                if (isBattleMode) {
                    snake = [{x:Math.floor(GRID/2),y:Math.floor(GRID/2)}];
                    dir = {x:1,y:0}; nextDir = {x:1,y:0};
                    return;
                }
                return endGame(true);
            }
        } else {
            if (head.x < 0) head.x = GRID - 1;
            if (head.x >= GRID) head.x = 0;
            if (head.y < 0) head.y = GRID - 1;
            if (head.y >= GRID) head.y = 0;
        }
        
        if (snake.some(s => s.x === head.x && s.y === head.y)) {
            if (isBattleMode) {
                snake = [{x:Math.floor(GRID/2),y:Math.floor(GRID/2)}];
                dir = {x:1,y:0}; nextDir = {x:1,y:0};
                return;
            }
            return endGame(true);
        }
        
        snake.unshift(head);
        let ate = false;
        
        foods.forEach((f, i) => {
            if (head.x === f.x && head.y === f.y) {
                foods.splice(i, 1);
                spawnFood();
                ate = true;
                score++;
                if (!isBattleMode) {
                    coins += 10;
                    triggerCoinPop(10);
                    updateCoinDisplay();
                }
                playSound('eat');
                if (isBattleMode) updateBattleScore();
            }
        });
        
        bonuses.forEach((b, i) => {
            if (head.x === b.x && head.y === b.y) {
                bonuses.splice(i, 1);
                ate = true;
                score += 10;
                if (!isBattleMode) {
                    coins += 100;
                    triggerCoinPop(100);
                    updateCoinDisplay();
                }
                playSound('bonus');
                triggerPop();
            }
        });
        
        document.getElementById('score-val').innerText = score;
        if (!ate) snake.pop();
    }

    function getCurrentSkinColor() {
        const skin = skins.find(s => s.id === selectedSkin);
        return skin ? skin.color : '#00ff00';
    }

    function render() {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, 600, 600);
        let hue = (Date.now() / 5) % 360;
        scorePop.style.color = `hsl(${hue}, 100%, 60%)`;
        scorePop.style.textShadow = `0 0 10px hsl(${hue}, 100%, 60%)`;

        foods.forEach(f => {
            ctx.shadowBlur = 25;
            ctx.shadowColor = '#f00';
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.arc(f.x*CELL+CELL/2, f.y*CELL+CELL/2, CELL/3, 0, 7);
            ctx.fill();
        });
        
        bonuses.forEach(b => {
            ctx.shadowBlur = 30;
            ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
            ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
            ctx.beginPath();
            ctx.arc(b.x*CELL+CELL/2, b.y*CELL+CELL/2, CELL/2.5, 0, 7);
            ctx.fill();
        });

        let snakeColor = getCurrentSkinColor();
        if (selectedSkin === 'rainbow') snakeColor = `hsl(${hue}, 100%, 50%)`;
        
        ctx.shadowBlur = 20;
        ctx.shadowColor = snakeColor;
        ctx.strokeStyle = snakeColor;
        ctx.lineWidth = CELL * 0.8;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        ctx.moveTo(snake[0].x*CELL+CELL/2, snake[0].y*CELL+CELL/2);
        
        for (let i = 1; i < snake.length; i++) {
            if (selectedSkin === 'rainbow') {
                ctx.stroke();
                ctx.strokeStyle = `hsl(${(hue + i * 20) % 360}, 100%, 50%)`;
                ctx.shadowColor = ctx.strokeStyle;
                ctx.beginPath();
                ctx.moveTo(snake[i-1].x*CELL+CELL/2, snake[i-1].y*CELL+CELL/2);
            }
            if (Math.abs(snake[i].x - snake[i-1].x) > 1 || Math.abs(snake[i].y - snake[i-1].y) > 1) {
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(snake[i].x*CELL+CELL/2, snake[i].y*CELL+CELL/2);
            } else {
                ctx.lineTo(snake[i].x*CELL+CELL/2, snake[i].y*CELL+CELL/2);
            }
        }
        ctx.stroke();
    }

    window.onkeydown = e => {
        const keys = {
            ArrowUp:{x:0,y:-1}, ArrowDown:{x:0,y:1}, ArrowLeft:{x:-1,y:0}, ArrowRight:{x:1,y:0},
            w:{x:0,y:-1}, s:{x:0,y:1}, a:{x:-1,y:0}, d:{x:1,y:0},
            W:{x:0,y:-1}, S:{x:0,y:1}, A:{x:-1,y:0}, D:{x:1,y:0}
        };
        const nd = keys[e.key];
        if (nd && (nd.x !== -dir.x || nd.y !== -dir.y)) {
            nextDir = nd;
            if (performance.now() - lastTime > speed * 0.3) lastTime = 0;
        }
        if (e.key === 'Escape' && gameActive && !isBattleMode) endGame(false);
        if (e.key === '`' && isDev) {
            showDevPanel();
        }
    };

    document.addEventListener('click', () => initAudio(), { once: true });
    document.addEventListener('keydown', () => initAudio(), { once: true });
</script>
</body>
</html>
